#!/bin/bash

if [ -e /var/log/chef/disabled ]; then
    exit 0
fi

export LC_ALL=en_US.UTF-8

chef-client \
    -l info \
    -L <%= @log_file %> \
<% if @json_attributes_file -%>
    -j <%= @json_attributes_file %> \
<% end -%>
    >/dev/null 2>&1

if [ "$?" == "0" ]; then
    echo 'ok' >/var/log/chef/last_run_status
else
    echo 'failed' >/var/log/chef/last_run_status
fi

chmod 640 <%= @log_file %>
chmod 644 /var/log/chef/last_run_status
